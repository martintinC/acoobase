{% extends "cahierDeSorties/base.html" %}
{% load static %}

{% block title %}Sorties en cours{% endblock %}

{% block content %}
    <!-- Style pour l'animation d'anniversaire -->
    {% if anniversaires %}
    <style>
        .birthday-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.6s ease;
            opacity: 0;
            min-width: 400px;
            border: 3px solid #ffd700;
        }
        
        .birthday-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            animation: pulse 0.5s ease-in-out 2;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: translateX(-50%) translateY(0) scale(1);
            }
            50% {
                transform: translateX(-50%) translateY(0) scale(1.05);
            }
        }
        
        .birthday-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .birthday-emoji {
            font-size: 2.5rem;
            animation: bounce 1s infinite;
        }
        
        .birthday-emoji:last-child {
            animation-delay: 0.2s;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .birthday-message {
            text-align: center;
            font-size: 1.2rem;
        }
        
        .birthday-message strong {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .birthday-names {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        @media (max-width: 576px) {
            .birthday-toast {
                min-width: 90%;
                padding: 20px;
            }
            
            .birthday-emoji {
                font-size: 2rem;
            }
            
            .birthday-message {
                font-size: 1rem;
            }
            
            .birthday-message strong {
                font-size: 1.2rem;
            }
        }
    </style>
    {% endif %}

    <h1 class="text-center mb-4">üö£‚Äç‚ôÇÔ∏è Sorties en cours</h1>

    <!-- Animation d'anniversaire -->
    {% if anniversaires %}
    <div id="birthday-toast" class="birthday-toast">
        <div class="birthday-content">
            <div class="birthday-emoji">üéÇüéâüéà</div>
            <div class="birthday-message">
                <strong>Joyeux anniversaire !</strong>
                <div class="birthday-names">
                    {% for rameur in anniversaires %}
                        <div>{{ rameur.prenom }} {{ rameur.nom }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="birthday-emoji">üéäü•≥üéÅ</div>
        </div>
    </div>
    {% endif %}

    <!-- Bouton pour ouvrir le modal -->
    <div class="text-end mb-3">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ajoutSortieModal">
            ‚ûï Ajouter une sortie
        </button>
    </div>

    {% if sorties %}
        <table class="table table-striped table-hover shadow-lg">
            <thead class="table-dark">
                <tr class="text-center">
                    <th class="w-50">Bateau</th>
                    <th class="w-50">Heure de d√©but</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for sortie in sorties %}
                <tr class="sortie-row {% if sortie.debut.date != today %}table-danger{% endif %}" data-sortie-id="{{ sortie.id }}">
                    <td>{{ sortie.bateau.nom }}</td>
                    <td>
                        {% if sortie.debut.date == today %}
                            {{ sortie.debut|date:"H:i" }}
                        {% else %}
                            {{ sortie.debut|date:"d/m/Y H:i" }}
                        {% endif %}
                    </td>
                </tr>

                    <!-- Rameurs : Cette ligne est cach√©e par d√©faut -->
                    <tr class="rameurs-row-{{ sortie.id }}" style="display: none;">
                        <td colspan="2">
                            <ul class="list-unstyled">
                                {% for sortie_rameur in sortie.sortierameur_set.all %}
                                    <li>{{ sortie_rameur.rameur.prenom }} {{ sortie_rameur.rameur.nom }}</li>
                                {% empty %}
                                    <li>Aucun rameur assign√©.</li>
                                {% endfor %}
                                {% if sortie.barreur %}
                                    <li>Barreur : {{ sortie.barreur.prenom }} {{ sortie.barreur.nom }}</li>
                                {% endif %}
                            </ul>
                            <div class="mb-3 text-center">
                                <label for="distance_{{ sortie.id }}" class="form-label">Distance (en km) :</label>
                                <input type="number" id="distance_{{ sortie.id }}" name="distance" class="form-control d-block mx-auto" step="1" min="0" style="width: 150px;" />
                            </div>
                            
                            <div class="text-center mt-2">
                                <button class="btn btn-success btn-sm valider-sortie" data-sortie-id="{{ sortie.id }}">‚úî Valider</button>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-danger btn-sm supprimer-sortie" data-sortie-id="{{ sortie.id }}">üóë Supprimer cette sortie</button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="alert alert-info text-center">
            Aucune sortie en cours pour le moment ‚è≥.
        </div>
    {% endif %}

    <!-- Modal Bootstrap -->
    <div class="modal fade" id="ajoutSortieModal" tabindex="-1" aria-labelledby="ajoutSortieModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚ûï Ajouter une sortie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ajoutSortieForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="selectBateau" class="form-label">Choisir un bateau :</label>
                            <select name="bateau" id="selectBateau" class="form-control">
                                <option value="">--- Choisir un bateau ---</option>
                                {% for bateau in form.fields.bateau.queryset %}
                                    <option value="{{ bateau.id }}" data-barre="{{ bateau.barre|yesno:'true,false' }}">{{ bateau.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Zone o√π les champs rameurs seront ajout√©s dynamiquement -->
                        <div id="rameursContainer"></div>

                        <!-- Champ barreur cach√© par d√©faut -->
                        <div id="barreur-field" style="display:none;">
                            <label for="id_barreur" class="form-label">Barreur :</label>
                            {{ form.barreur }}
                        </div>

                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <!-- D√©finition de l'URL de 'get_rameurs' sans ID -->
    <script>
        var getRameursUrlBase = "{% url 'get_rameurs' 0 %}";
        var ajouterSortieUrl = "{% url 'ajouter_sortie' %}";
        var supprimerSortieUrlBase = "{% url 'supprimer_sortie' '0' %}";
        var validerSortieUrlBase = "{% url 'valider_sortie' '0' %}";
    </script>

    <!-- Script sp√©cifique √† la page des sorties en cours -->
    <script src="{% static 'js/sorties_en_cours.js' %}" defer></script>
    
    <!-- Script pour l'animation d'anniversaire -->
    {% if anniversaires %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const birthdayToast = document.getElementById('birthday-toast');
            if (birthdayToast) {
                console.log('Birthday toast found!');
                // Afficher l'animation apr√®s un petit d√©lai
                setTimeout(function() {
                    console.log('Adding show class...');
                    birthdayToast.classList.add('show');
                }, 500);
                
                // Masquer l'animation apr√®s 6 secondes
                setTimeout(function() {
                    console.log('Removing show class...');
                    birthdayToast.classList.remove('show');
                }, 6500);
            } else {
                console.log('Birthday toast NOT found!');
            }
        });
    </script>
    {% endif %}
{% endblock %}